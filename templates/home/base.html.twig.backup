<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8">
		<meta
		name="viewport" content="width=device-width, initial-scale=1.0">
		<!-- Forzar recarga completa del head cuando se visita esta página con Turbo -->
		<meta name="turbo-visit-control" content="reload">
		<title>
			{% block title %}Panel de Control
			{% endblock %}
		</title>


		{% block stylesheets %}
			<!-- Bootstrap CSS -->
			<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" data-turbo-track="reload">
			<!-- Font Awesome Icons para íconos de navbar y cards -->
			<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkfQ0Ax7Anxr1j7rwhhtjfiVxzG7Z9G8V3GZC2Bz8pS0VQvR5c5a7p3HQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
			<!-- Fuente moderna y legible -->
			<link rel="preconnect" href="https://fonts.googleapis.com">
			<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
			<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
			<style data-turbo-track="reload">
				:root {
					--brand-primary: #0d6efd;
					--brand-muted: #6c757d;
					--border-color: #e9ecef;
					--bg-soft: #f8f9fa;
					--radius-sm: .375rem;
					--radius-md: .5rem;
					--shadow-sm: 0 .125rem .25rem rgba(0,0,0,.075);
				}
				* {
					margin: 0;
					padding: 0;
					box-sizing: border-box;
				}

				html,
				body {
					margin: 0;
					padding: 0;
					font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
					overflow-x: hidden;
					height: 100%;
				}

				/* Navbar superior */
				.top-navbar {
					border-bottom: 1px solid #e5e7eb;
					background: #ffffff;
					position: sticky;
					top: 0;
					z-index: 1030;
				}
				.top-navbar .nav-link { color: #495057; }
				.top-navbar .nav-link:hover { color: var(--brand-primary); }
				.brand-text { font-weight: 600; }

				.layout-wrapper {
					display: flex;
					width: 100%;
					min-height: calc(100vh - 120px);
					padding-bottom: 60px;
				}
				.sidebar {
					width: 250px;
					min-width: 250px;
					background: var(--bg-soft);
					border-right: 1px solid var(--border-color);
					padding: 1rem;
					overflow-y: auto;
				}
				.sidebar.collapsed { width: 0; min-width: 0; padding: 0; border-right: 0; overflow: hidden; }
				.sidebar-toggle { cursor: pointer; }

				.sidebar .user-info {
					background: #e9ecef;
					padding: 1rem;
					margin-bottom: 1rem;
					border-radius: var(--radius-sm);
				}

				.sidebar .user-info p {
					margin: 0;
					font-size: 0.875rem;
				}

				.sidebar .nav-link {
					color: #212529;
					padding: 0.5rem 0.75rem;
					border-radius: var(--radius-sm);
					margin-bottom: 0.25rem;
					transition: background .2s ease, color .2s ease, padding-left .2s ease;
				}
				.sidebar .nav-link:hover { background: #e7f1ff; color: #0a58ca; padding-left: 1rem; }
				.sidebar .nav-link.active { background: #e7f1ff; color: #0a58ca; border-left: 3px solid var(--brand-primary); }

				.main-content {
					flex: 1;
					padding: 1.25rem 1.5rem 2.5rem;
					background: #ffffff;
					width: 100%;
					overflow-x: hidden;
				}

				.main-content h1 {
					margin-bottom: 1.5rem;
				}

				/* Encabezado de contenido con breadcrumbs a la derecha */
				.content-header { border-bottom: 1px solid var(--border-color); padding-bottom: .75rem; margin-bottom: 1rem; }
				.content-header h1 { font-size: 1.25rem; margin: 0; }

			/* Card tools (minimizar/cerrar) */
			.card { box-shadow: var(--shadow-sm); border-color: var(--border-color); border-radius: var(--radius-md); }
			.card-header { background: #fff; border-bottom: 1px solid var(--border-color); }
			.card-title { font-size: 1rem; font-weight: 600; }
			.card-tools { display: flex; align-items: center; gap: .5rem; }
			.card-tool {
				border: 0;
				background: transparent;
				color: #6c757d;
				padding: .5rem;
				cursor: pointer;
				font-size: 1rem;
				line-height: 1;
				transition: all .2s ease;
				display: inline-flex;
				align-items: center;
				justify-content: center;
				min-width: 30px;
				min-height: 30px;
			}
			.card-tool:hover {
				color: #495057;
				background: #f8f9fa;
				border-radius: .25rem;
			}
			.card-tool i {
				font-size: 1rem;
				line-height: 1;
			}

			/* Asegurar que Font Awesome se renderice correctamente */
			.fas, .fa-solid {
				font-family: "Font Awesome 6 Free";
				font-weight: 900;
			}

			.card-collapsed .card-body, .card-collapsed .card-footer { display: none; }				/* Breadcrumbs minimalistas */
				.breadcrumb { margin-bottom: 0; --bs-breadcrumb-divider-color: #adb5bd; }
				.breadcrumb .breadcrumb-item + .breadcrumb-item::before { color: #adb5bd; }
				.breadcrumb .breadcrumb-item a { color: #6c757d; text-decoration: none; }
				.breadcrumb .breadcrumb-item a:hover { color: #495057; text-decoration: underline; }

				/* Tablas y contenido dentro de cards */
				.card-body { overflow-x: auto; }
				.table th { font-weight: 600; color: #495057; }
				.table td, .table th { vertical-align: middle; }
				.table tr:last-child td { border-bottom: 0; }

				@media(max-width: 992px) {
					.layout-wrapper {
						flex-direction: column;
					}

					.sidebar {
						width: 100%;
						min-width: 100%;
						border-right: none;
						border-bottom: 2px solid #dee2e6;
					}

					.main-content {
						padding: 1rem;
					}
				}

				@media(max-width: 576px) {
					.header-title {
						font-size: 1.25rem;
						padding: 1rem;
					}

					.horizontal-menu .nav {
						flex-direction: column;
					}

					.main-content {
						padding: 0.75rem;
					}
				}

				.footer {
					background: #f8f9fa;
					border-top: 2px solid #dee2e6;
					padding: 1rem;
					text-align: center;
					color: #6c757d;
					font-size: 0.875rem;
					position: fixed;
					bottom: 0;
					left: 0;
					right: 0;
					width: 100%;
					z-index: 1000;
				}
			</style>
		{% endblock %}
		{% block javascripts %}

			{% block importmap %}
				{{ importmap('app') }}
			{% endblock %}
			<!-- Bootstrap JS -->
			<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
			<!-- SweetAlert2 -->
			<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
		{% endblock %}
	</head>
	<body>
		<!-- Navbar superior -->
		<nav class="navbar navbar-expand-lg top-navbar px-3">
			<div class="container-fluid">
				<button class="btn btn-outline-secondary me-2 sidebar-toggle" id="sidebarToggle" title="Mostrar/Ocultar menú">
					<i class="fa-solid fa-bars"></i>
				</button>
				<a class="navbar-brand d-flex align-items-center" href="{{ path('app_home') }}">
					<span class="brand-text">Admin</span><span class="text-primary">Panel</span>
				</a>
				<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNavbarContent" aria-controls="topNavbarContent" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="topNavbarContent">
					<ul class="navbar-nav me-auto mb-2 mb-lg-0">
						<li class="nav-item"><a class="nav-link" href="{{ path('app_home') }}">Home</a></li>
						<li class="nav-item"><a class="nav-link" href="#">Contact</a></li>
					</ul>
					<ul class="navbar-nav ms-auto">
						<li class="nav-item me-2"><a class="nav-link" href="#" title="Notificaciones"><i class="fa-regular fa-bell"></i></a></li>
						<li class="nav-item me-2"><a class="nav-link" href="#" title="Mensajes"><i class="fa-regular fa-envelope"></i></a></li>
						<li class="nav-item"><a class="nav-link" href="#" title="Perfil"><i class="fa-regular fa-user"></i></a></li>
					</ul>
				</div>
			</div>
		</nav>


		<!-- Contenedor principal con sidebar y contenido -->
		<div
			class="layout-wrapper">
			<!-- Menú lateral -->
			<aside
				class="sidebar" id="appSidebar">
				{# Ruta actual para marcar enlaces activos #}
				{% set current_route = app.request.attributes.get('_route') %}
				<!-- Información del usuario -->
				{% if app.user %}
					<div class="user-info">
						<p class="mb-1 text-muted">Bienvenido/a</p>
						{% if app.user.name %}
							<p class="fw-bold mb-2">{{ app.user.name }}</p>
						{% else %}
							<p class="fw-bold mb-2">{{ app.user.userIdentifier }}</p>
						{% endif %}
						<a href="{{ path('app_logout') }}" class="btn btn-primary btn-sm w-100">Cerrar sesión</a>
					</div>
				{% endif %}

				<!-- Menú de navegación -->
				<ul class="nav flex-column">
					<li class="nav-item text-uppercase text-muted small" style="pointer-events: none;">Usuarios</li>
					<li class="nav-item">
						<a class="nav-link {{ current_route == 'app_home' ? 'active' : '' }}" href="{{ path('app_home') }}">Inicio</a>
					</li>


					<li
						class="nav-item">
						{# Perfil (show, edit) #}
						<a class="nav-link {{ current_route starts with 'app_profile_' ? 'active' : '' }}" href="{{ path('app_profile_show') }}">Mi perfil</a>
					</li>


					{% if is_granted('ROLE_ADMIN') %}
						<li class="nav-item text-uppercase text-muted small" style="pointer-events: none;">Administrativa</li>

						<li
							class="nav-item">
							{# Cualquier ruta que empiece por app_user_ (index, new, show, edit) #}
							<a class="nav-link {{ current_route starts with 'app_user_' ? 'active' : '' }}" href="{{ path('app_user_index') }}">Usuarios</a>
						</li>

						<li
							class="nav-item">
							{# Cualquier ruta que empiece por app_categoria_ #}
							<a class="nav-link {{ current_route starts with 'app_categoria_' ? 'active' : '' }}" href="{{ path('app_categoria_index') }}">Categorías</a>
						</li>

						<li class="nav-item">
							<a class="nav-link {{ current_route == 'app_prueba' ? 'active' : '' }}" href="{{ path('app_prueba') }}">Prueba</a>
						</li>

						<li class="nav-item">
							<a class="nav-link {{ current_route == 'app_product_index' ? 'active' : '' }}" href="{{ path('app_product_index') }}">Productos</a>
						</li>
					{% endif %}
				</ul>
			</aside>

			<!-- Contenido principal -->
			<main class="main-content">
				<div class="content-header d-flex align-items-center justify-content-between">
					<h1 class="m-0">{% block page_heading %}{{ block('title') }}{% endblock %}</h1>
					<div class="ms-auto">
						{% block breadcrumbs %}
							{% include 'partials/_breadcrumbs.html.twig' with { items: [ { label: 'Dashboard', active: true } ] } %}
						{% endblock %}
					</div>
				</div>
				{# SISTEMA DE MENSAJES FLASH
				   Los mensajes flash son notificaciones temporales que se muestran después de una acción.
				   Se añaden desde los controladores con: $this->addFlash('tipo', 'mensaje');
				   Tipos disponibles: success, error, warning, info
				   Los mensajes se eliminan automáticamente después de mostrarse una vez.
				#}
				<!-- Mensajes Flash -->
				{% for label, messages in app.flashes %}
					{% for message in messages %}
						{# Mensaje de ÉXITO - Fondo verde (Bootstrap: alert-success) #}
						{% if label == 'success' %}
							<div class="alert alert-success alert-dismissible fade show" role="alert">
								<strong>✓ Éxito:</strong> {{ message }}
								<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
							</div>
						{% elseif label == 'error' %}
							<div class="alert alert-danger alert-dismissible fade show" role="alert">
								<strong>✗ Error:</strong> {{ message }}
								<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
							</div>
						{% elseif label == 'warning' %}
							<div class="alert alert-warning alert-dismissible fade show" role="alert">
								<strong>⚠ Advertencia:</strong> {{ message }}
								<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
							</div>
						{% elseif label == 'info' %}
							<div class="alert alert-info alert-dismissible fade show" role="alert">
								<strong>ℹ Info:</strong> {{ message }}
								<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
							</div>
						{% endif %}
					{% endfor %}
				{% endfor %}

				{# (Breadcrumbs ya se renderiza arriba en la cabecera de contenido) #}

				{% block content %}
					{% if template_path is defined %}
						{{ include(template_path) }}
					{% endif %}
				{% endblock %}
			</main>
		</div>

		<!-- Footer -->
		<footer class="footer">
			<p class="mb-0">Creado por Jhonatan Fernandez ©
				{{ "now"|date("Y") }}</p>
		</footer>

		<!-- Script global: confirmación SweetAlert2 para formularios de eliminar -->
		<script>
			// Toggle del sidebar
			document.getElementById('sidebarToggle')?.addEventListener('click', function () {
				const sb = document.getElementById('appSidebar');
				if (!sb) return;
				sb.classList.toggle('collapsed');
			});

			// Herramientas de Card: colapsar y cerrar (compat: data-card-tool o data-card-widget)
			document.addEventListener('click', function(e){
				const btn = e.target.closest('[data-card-tool], [data-card-widget]');
				if (!btn) return;
				const card = btn.closest('.card');
				if (!card) return;
				const action = btn.getAttribute('data-card-tool') || btn.getAttribute('data-card-widget');
				if (action === 'collapse') {
					card.classList.toggle('card-collapsed');
				} else if (action === 'remove') {
					card.remove();
				}
			});

			// Listener global que escucha TODOS los eventos 'submit' del documento
document.addEventListener('submit', function (e) { // Capturamos el elemento que disparó el evento (el formulario)
const form = e.target;

// Verificamos que sea un formulario HTML válido
if (!(form instanceof HTMLFormElement))
return;



// FILTRO CLAVE: Solo procesamos formularios con la clase 'js-delete-form'
// Si el formulario NO tiene esta clase, el script se ignora y el formulario funciona normal
if (! form.classList.contains('js-delete-form'))
return;



// Protección contra doble envío:
// Cuando ejecutamos form.submit() programáticamente, se vuelve a disparar este listener
// Este flag evita que se muestre el diálogo dos veces
if (form.dataset.confirmed === 'true')
return;



// Detenemos el envío automático del formulario para mostrar primero la confirmación
e.preventDefault();

// Leemos los textos personalizados desde los atributos data-* del formulario
// Si no existen, usamos valores por defecto en español
// Ejemplo: data-swal-title="¿Eliminar categoría?" se lee como form.dataset.swalTitle
const title = form.dataset.swalTitle || '¿Eliminar este registro?';
const text = form.dataset.swalText || 'Esta acción no se puede deshacer.';
const confirmText = form.dataset.swalConfirm || 'Sí, eliminar';
const cancelText = form.dataset.swalCancel || 'Cancelar';

// Mostramos el diálogo de confirmación SweetAlert2
Swal.fire({
title: title, // Título principal del modal
text: text, // Texto descriptivo debajo del título
icon: 'warning', // Icono de advertencia (⚠️)
showCancelButton: true, // CRÍTICO: Muestra el botón "Cancelar" (hace que sea un diálogo de decisión)
confirmButtonText: confirmText, // Texto del botón de confirmación
cancelButtonText: cancelText, // Texto del botón de cancelación
confirmButtonColor: '#d33', // Color rojo para el botón de eliminar (peligro)
cancelButtonColor: '#6c757d', // Color gris para el botón cancelar (neutral)
reverseButtons: true // Invierte el orden: Cancelar a la izquierda, Confirmar a la derecha
}).then((result) => {
// Esta función se ejecuta DESPUÉS de que el usuario hace clic en algún botón

// Si el usuario hizo clic en "Sí, eliminar" (confirmó)
if (result.isConfirmed) { // Marcamos el formulario como confirmado para evitar el bucle infinito
form.dataset.confirmed = 'true';

// Ahora SÍ enviamos el formulario al servidor para eliminar el registro
form.submit();
}
// Si el usuario hizo clic en "Cancelar" o cerró el modal:
// No entramos al if, no pasa nada, el modal se cierra y el registro NO se elimina
});
});
		</script>
	</body>
</html>
